import pyautogui
import platform
import os
import subprocess

def adjust_coordinates(x, y):
    screen_width, screen_height = pyautogui.size()
    os_name = platform.system()

    if os_name == 'Darwin':  # För macOS
        if pyautogui.is_retina():  # Kontrollera om det är en Retina-skärm
            screen_width *= 2
            screen_height *= 2
    elif os_name == 'Windows':  # För Windows
        try:
            import ctypes
            user32 = ctypes.windll.user32
            screen_width = user32.GetSystemMetrics(0)
            screen_height = user32.GetSystemMetrics(1)
        except:
            pass
    elif os_name == 'Linux':  # För Linux
        try:
            output = subprocess.check_output(['xrandr']).decode('utf-8')
            for line in output.splitlines():
                if ' connected' in line:
                    line_parts = line.split()
                    screen_size = line_parts[line_parts.index('connected') + 1]
                    screen_width, screen_height = map(int, screen_size.split('x'))
                    break
        except:
            pass

    adjusted_x = x * screen_width
    adjusted_y = y * screen_height
    return adjusted_x, adjusted_y

from scaledefine import tested_scale

result = tested_scale()
if result is not None:
    scale_factor = result

    # Använd det fastställda skalvärdet för att leta efter nästa bild
    # Förutsättningen är att bilden finns i mappen "img" med namnet "stone_image.png"
    image_path = f"img/stone_image.png"

    try:
        found_image = pyautogui.locateOnScreen(image_path, confidence=0.5)

        if found_image is not None:
            adjusted_x, adjusted_y = adjust_coordinates(found_image.left + found_image.width // 2,
                                                       found_image.top + found_image.height // 2)
            pyautogui.moveTo(adjusted_x, adjusted_y)
            print("Bild hittad!")
        else:
            print(f"Hittar inte {image_path}")
    except Exception as e:
        print(f"Fel vid bildsökning: {str(e)}")
else:
    print("Ingen bild hittades för att fastställa skalan.")
